# 萌新绕道！！！萌新绕道！！！萌新绕道！！！这项目不适合你，请自觉关闭网页
# oitq
<div align="center">
    <p>用于生产环境部署oicq</p>

[![dm](https://shields.io/npm/dm/oitq)](https://www.npmjs.com/package/oitq)
[![qq group](https://img.shields.io/badge/group-860669870-blue?style=flat-square&labelColor=FAFAFA&logo=data:image/png;base64,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&logoColor=000000)](https://jq.qq.com/?_wv=1027&k=B22VGXov)
[![npm package](https://img.shields.io/npm/v/oitq?color=57B497&label=oitq&style=flat-square&labelColor=FAFAFA&logo=npm&logoColor=FCAA00)](https://www.npmjs.com/package/oitq)
[![node engine](https://img.shields.io/node/v/oitq?color=339933&style=flat-square&labelColor=FAFAFA&logo=Node.js)](https://nodejs.org)
</div>
## 安装
```shell
npm install oitq
# or
yarn add oitq
```
## 样例
### 1. 通过cli启动(需配合oitq.config.json使用)

```shell
npm install @oitq/cli
# or
yarn add @oitq/cli
```
package.json添加启动脚本
```json
"scripts":{
"start":"oitq start . --log-level info"
}
```

###2. 通过编写入口文件启动(需配合oitq.config.json使用)
```typescript
import {createApp} from 'oitq'
createApp().start()
```
###3. 通过编写入口文件启动（无需oitq.config.json，在createApp时传入配置）

```typescript
import {createApp,Plugin} from 'oitq'
const echo={
    name:'echo',
    install:(ctx,config)=>{
        // 添加一个echo指令
        ctx.command('echo','输出信息')
            .action(async ({session})=>{
                // 调起使用prompt可以监听用户下一次的输入作为本次的参数继续执行，
                // prompt配置具体见Prompt介绍
                const {message} = await session.prompt({
                    type:'text',
                    message:'请输入你需要输出的信息',
                    name:'message'
                })
                if(message){
                    session.reply(message)
                }
            })
    }
}
// createApp可以传AppOptions对象，也可以是josn文件路径，不传时默认为电脑home目录下的.oitq/oitq.json
const app=createApp({
    dir:'./plugins',//你自己写的插件在哪个目录
    bots:[
        {
            uin:147258369,//登录bot账号
            type:'qrcode',//登录方式，可选password/qrcode,当为password时，需配置password字段
            admins:[],//管理此bot的qq号数组
            config:{
                platform:5,//登录平台
            },
            oneBot:false,//是否启用oneBot，可传boolean或OneBotConfig
        }
    ]
})
// 已函数形式添加一个插件
app.plugin((plugin:Plugin)=>{
    // 监听私聊消息
    plugin.on('bot.message.friend',(session)=>{
        if(session.cqCode==='test'){
            return 'hello world'
        }
    })
})
// 传入name字符串时，程序会自己去查找符合名字的插件进行安装
// 查找顺序
// 1.appOption传入的dir目录
// 2.名称为`oitq-plugin-${name}`的npm包
// 3.名称为`@oitq/plugin-${name}`的npm包
app.plugin('example')
// 如果传入的是一个对象，则安装插件时会自动执行对象上的install方法
app.plugin(echo,{auth:1})
app.start(8080)
```
## 编写插件
oitq 规定插件为函数类型或带有install函数的对象，
在调用app.plugin时，oitq将会生成一个全新的上下文作为参数传递给插件
，如果你调用app.plugin时传入了第二个参数，那么他也会作为config传入到插件里
在插件内部，你可通过上下文上提供的各种方法和服务来编写你自己的逻辑

```typescript
// example.ts
import {Plugin} from 'oitq'
export function install(plugin:Plugin){
    plugin.on('bot.group.message',(session)=>{
        // oitq将会自动将收到的消息转为CQ码存到会话的cqCode字段上，
        // 你也可以使用session.message 获取原来的message
        if(session.cqCode==='123'){
            // 如果回调函数有返回值且返回值为string类型，程序会自动将返回值作为消息发送至对应群
            // 你也可以手动调用session.reply(message)进行快速回复
            return '456'
        }
    })
}
```
## prompt
为了实现qq应答式的让用户输入信息，oitq在session上添加了prompt函数，你可以通过调用让用户输入一些信息

prompt接收一个Option或Option数组，为数组时可同时让用户输入多次
```typescript

interface TypeKV{
    text:string,
    any:any
    video:VideoElem
    image:ImageElem
    face:FaceElem
    number:number,
    list:any[]
    confirm:boolean
    date:Date
    select:any
    multipleSelect:any[]
}
interface Option<T extends keyof TypeKV>{
    type:T | Falsy | PrevCaller<T,T|Falsy>,// 必填，可以使TypeKV的key值或一个返回值为TypeKv的key值得函数
    name?:string,//必填，多个问题时，name应具有唯一性
    message?:Sendable,//可选 提示用户输入的文本，没传则会依据label、prefix、action拼接以提示用户，拼接规则(prefix+action+label)
    label?:Sendable,//可选,没传则为name
    prefix?:string,//可选
    action?:string,//可选
    validate?:(message:Sendable)=>boolean,//可选 用户输入值校验函数
    errorMsg?:string,// 可选 校验出错时提示用户的错误信息
    separator?:string|PrevCaller<T, string>,// 可选 当type为list或multipleSelect时为必传，确定值之间的分隔标识
    choices?:ChoiceItem[]|PrevCaller<T,ChoiceItem[]>,// 可选 当type为select或multipleSelect时必传，提供个用户选择的列表，
    initial?:ValueType<T>|PrevCaller<T, ValueType<T>>,// 可选，选项的默认值
    timeout?:number,// 可选，用户输入超时的时间毫秒数，默认为createApp时传入的delay.prompt值
    format?:(value:ValueType<T>)=>ValueType<T>,// 可选，对用户返回值进行格式化的函数
}
interface ChoiceItem{
    title:string,
    value:any
}
```
# 鸣谢
1. [koishi](https://github.com/koishijs/koishi) 本项目是基于koishi的源码进行了改造
3. [oicq](https://github.com/takayama-lily/oicq) 提供底层协议支持
2. [prompts](https://github.com/terkelg/prompts) 本项目prompt功能代码参考了terkelg的prompts
